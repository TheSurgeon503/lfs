<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-tools-cleanup">
  <?dbhtml filename="cleanup.html"?>

  <title>Cleaning up and Saving the Temporary System</title>

  <sect2>
    <title>Cleaning</title>

    <para>First, remove the currently installed documentation files to prevent them
    from ending up in the final system, and to save about 35 MB:</para>

<screen><userinput>rm -rf /usr/share/{info,man,doc}/*</userinput></screen>

    <para>Second, on a modern Linux system, the libtool .la files are only
    useful for libltdl.  No libraries in LFS are loaded by
    libltdl, and it's known that some .la files can cause BLFS package
    failures.  Remove those files now:</para>

<screen><userinput>find /usr/{lib,libexec} -name \*.la -delete</userinput></screen>

    <para>
      The current system size is now about 3 GB, however
      the /tools directory is no longer needed. It uses about
      1 GB of disk space.  Delete it now:
    </para>

<screen><userinput>rm -rf /tools</userinput></screen>
  </sect2>

  <sect2>
    <title>Backup</title>

    <para>
      At this point the essential programs and libraries have been created
      and your current LFS system is in a good state. Your system can now be
      backed up for later reuse. In case of fatal failures in the subsequent
      chapters, it often turns out that removing everything and starting over
      (more carefully) is the best way to recover. Unfortunately, all the
      temporary files will be removed, too. To avoid spending extra time to
      redo something which has been done successfully, creating a backup of
      the current LFS system may prove useful.
    </para>

    <note><para>
      All the remaining steps in this section are optional. Nevertheless,
      as soon as you begin installing packages in <xref
      linkend="chapter-building-system"/>, the temporary files will be
      overwritten. So it may be a good idea to do a backup of the current
      system as described below.
    </para></note>

    <para>
       If you are making a backup, mount the partition for backup:
    </para>

<screen role="nodump"><userinput>mount -v /dev/sda<replaceable>4</replaceable> /mnt</userinput></screen>

    <para>
      Make sure you have at least 1 GB free disk space (the source tarballs
      will be included in the backup archive) in the partition prepared for
      backup.
    </para>

    <para>
      Note that the instructions below specify the home directory of the host
      system's <systemitem class="username">root</systemitem> user, which is
      typically found on the root file system.
      Replace <envar>$HOME</envar> by a directory of your choice if you
      do not want to have the backup stored in <systemitem
      class="username">root</systemitem>'s home directory.
    </para>

    <para>
      Create the backup archive by running the following command:
    </para>

    <note>
       <para>
          Because the backup archive is compressed, it takes a relatively
          long time (over 10 minutes) even on a reasonably fast system.
       </para>
    </note>

<screen role="nodump"><userinput>cd /
tar -cJpf /mnt/lfs-temp-tools-&version;.tar.xz . \
    --exclude="dev/*" --exclude="proc/*"
    --exclude="sys/*" --exclude="run/*"
    --exclude="mnt/*"</userinput></screen>

    <para>Unmount the partition containing the backup:</para>

<screen role="nodump"><userinput>umount /mnt</userinput></screen>

  </sect2>

  <sect2>
    <title>Restore</title>

    <para>
      In case some mistakes have been made and you need to start over, you can
      use this backup to restore the system and save some recovery time.
      Since the sources are included in the
      backup archive as well, so they do not need to be downloaded again.
    </para>

    <warning><para>
      Power off the target system and reconnect the disk containing LFS
      temporary system to the host for restoring the backup.  It's necessary
      to avoid overwriting some binaries being used.  Because the package
      providing <command>shutdown</command> command is not built yet, the
      system can't be shut down cleanly.  Issue <command>sync</command> to
      ensure all filesystem writes cached in memory to be really written
      into the disk, then power off the system physically (for example,
      unplug the AC cord).
    </para></warning>

    <para>Mount the LFS partition and the backup partition on
    <emphasis role="bold">the host system</emphasis>:</para>

<!-- Make the following look different so users don't blindly run the
     restore when they don't need to. -->

<screen role="nodump"><computeroutput>mkdir -pv /mnt/lfs-{target,backup}
mount -v -t ext4 <replaceable>/dev/sdx</replaceable>3 /mnt/lfs-target
mount -v -t ext4 <replaceable>/dev/sdx4</replaceable> /mnt/lfs-backup</computeroutput></screen>


    <warning><para>The following commands are extremely dangerous.  If
    you run <command>rm -rf ./*</command> as the &root; user and you
    do not change to the <filename>lfs-target</filename> directory,
    it will destroy your entire host system.
    YOU ARE WARNED.</para></warning>

<screen role="nodump"><computeroutput>cd /mnt/lfs-target
rm -rf ./*
tar -xpf /mnt/lfs-backup/lfs-temp-tools-&version;.tar.xz</computeroutput></screen>

    <para>
       Again, unmount the two partitions, reconnect the device to the target
       machine, boot it and continue building the rest of system:
    </para>

<screen role="nodump"><computeroutput>umount /mnt/lfs-{target,backup}</computeroutput></screen>

    <important>
      <para>
         If you reboot your target machine and restart
         building using a restore, remount the virtual filesystems now as
         described in <xref linkend='ch-tools-kernfs'/> and re-enter the build
         environment (see <xref linkend='ch-tools-chroot'/>) before continuing.
       </para>
    </important>

  </sect2>

</sect1>
